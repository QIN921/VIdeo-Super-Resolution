<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>视频播放器</title>
    <style>
        #imageContainer {
            display: flex;
        }

        .preview-container {
            overflow: auto;
            height: 450px;
            width: 800px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 100%;
            cursor: grab;
        }

        #controls {
            clear: both;
            padding: 10px;
        }

        #videoPlayer {
            width: 50%;
        }
    </style>
</head>
<body>
    <h1>选择文件</h1>
    <form id="fileForm">
        <input type="file" name="fileInput" id="fileInput">
        <label for="scaleSelect">放大倍数：</label>
        <select id="scaleSelect">
            <option value="1">原始大小</option>
            <option value="2">2倍</option>
            <option value="3">3倍</option>
            <option value="4">4倍</option>
        </select>
        <button type="submit">上传</button>
    </form>

    <pre id="result"></pre>

    <div id="messagecontainer" style="margin: 20px;"> </div>
    <hr/>

    <h1>视频播放器</h1>
    <input type="file" id="videoFileInput">
    <br>
    <video id="videoPlayer" controls></video>

    <script>
        const videoFileInput = document.getElementById('videoFileInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const result = document.getElementById('result');

        videoFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const videoURL = URL.createObjectURL(file);
            videoPlayer.src = videoURL;
        });

        function togglePlay() {
            if (videoPlayer.paused || videoPlayer.ended) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }

        function toggleFullScreen() {
            if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen();
            } else if (videoPlayer.mozRequestFullScreen) {
                videoPlayer.mozRequestFullScreen();
            } else if (videoPlayer.webkitRequestFullscreen) {
                videoPlayer.webkitRequestFullscreen();
            } else if (videoPlayer.msRequestFullscreen) {
                videoPlayer.msRequestFullscreen();
            }
        }

        videoPlayer.addEventListener('click', togglePlay);
        videoPlayer.addEventListener('dblclick', toggleFullScreen);

        const form = document.getElementById('fileForm');

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const fileInput = document.getElementById('fileInput');
            
            if (fileInput.files.length === 0) {
                result.textContent = '请选择文件';
                return;
            }

            const formData = new FormData();
            const scaleSelect = document.getElementById('scaleSelect');
            const selectedScale = scaleSelect.value;

            formData.append('file', fileInput.files[0]);
            formData.append('scale', selectedScale)

            fetch('/upload_2', { // 修改为上传处理的URL
                method: 'POST',
                body: formData
            }).then(response => response.text())
              .then(data => {
                  result.textContent = data;
              });
        });   
    </script>
    <script src="jquery-3.7.1.min.js"></script>
    <script src="https://cdn.staticfile.org/socket.io/4.5.2/socket.io.min.js"></script>
    <script>
        var socket = io();
        //记录上一次显示位置
        var lastloc = null;
        socket.on("connect", function () {

        });
        
        socket.on("server_response_2", function (msg) {
            //接收到后端发送过来的消息
            var t = msg.data;
            console.log('message: ' + t);
            $('#messagecontainer').append(t +'<br/>');
        });
    
    </script>
    
    <h1>选择文件夹，将展示其中图片</h1>

    <input type="file" id="leftFolderUpload" webkitdirectory directory multiple>
    <input type="file" id="rightFolderUpload" webkitdirectory directory multiple>

    <div id="imageContainer" >
        <div id="leftPreview" class="preview-container" onscroll="syncScroll('left')"></div>
        <div id="rightPreview" class="preview-container" onscroll="syncScroll('right')"></div>
    </div>

    <div id="controls">
        <button id="previousBtn" onclick="showPrevious()">上一张</button>
        <button id="nextBtn" onclick="showNext()">下一张</button>
        <button id="zoomInBtn" onclick="zoomIn()">放大</button>
        <button id="zoomOutBtn" onclick="zoomOut()">缩小</button>
        <button id="zoomBtn" onclick="resetZoom()">适应</button>
    </div>

    <script>
        let leftFileIndex = 0;
        let rightFileIndex = 0;
        let leftImageFiles = [];
        let rightImageFiles = [];

        const leftFolderUploadInput = document.getElementById('leftFolderUpload');
        const rightFolderUploadInput = document.getElementById('rightFolderUpload');
        const leftPreviewDiv = document.getElementById('leftPreview');
        const rightPreviewDiv = document.getElementById('rightPreview');
        const previousBtn = document.getElementById('previousBtn');
        const nextBtn = document.getElementById('nextBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomBtn = document.getElementById('zoomBtn');
        let scaleFactor = 0.2;

        leftFolderUploadInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            leftImageFiles = files.filter(file => file.type.startsWith('image/'));
            leftImageFiles.sort((a, b) => getImageIndex(a) - getImageIndex(b));  // 按照图片索引进行排序
            leftFileIndex = 0;
            showImage('left');      
        });

        rightFolderUploadInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            rightImageFiles = files.filter(file => file.type.startsWith('image/'));
            rightImageFiles.sort((a, b) => getImageIndex(a) - getImageIndex(b));  // 按照图片索引进行排序
            rightFileIndex = 0;
            showImage('right');
        });

        function getImageIndex(file) {
            const fileName = file.name.toLowerCase();
            const match = fileName.match(/frame_(\d+)\.(png|jpg)/);
            return match ? parseInt(match[1]) : -1;
        }

        function showImage(side) {
            let imageFiles, fileIndex, previewDiv;
            if (side === 'left') {
                imageFiles = leftImageFiles;
                fileIndex = leftFileIndex;
                previewDiv = leftPreviewDiv;
            } else {
                imageFiles = rightImageFiles;
                fileIndex = rightFileIndex;
                previewDiv = rightPreviewDiv;
            }
        
            if (imageFiles.length === 0) {
                previewDiv.innerHTML = '没有选择图片文件夹或文件夹内没有图片';
                return;
            }
            
            const file = imageFiles[fileIndex];
            const reader = new FileReader();
            reader.onload = function() {
                const image = new Image();
                image.src = reader.result;
                image.id = 'preview-image';
                image.style.transform = `scale(${scaleFactor})`;
                previewDiv.innerHTML = '';
                previewDiv.appendChild(image);
            };
            
            reader.readAsDataURL(file);
            previousBtn.disabled = (fileIndex === 0);
            nextBtn.disabled = (fileIndex === imageFiles.length - 1);
        }

        function showPrevious() {
            if (leftFileIndex > 0) {
                leftFileIndex--;
                showImage('left');
            }
            if (rightFileIndex > 0) {
                rightFileIndex--;
                showImage('right');
            }
        }

        function showNext() {
            if (leftFileIndex < leftImageFiles.length - 1) {
                leftFileIndex++;
                showImage('left');
            }
            if (rightFileIndex < rightImageFiles.length - 1) {
                rightFileIndex++;
                showImage('right');
            }
        }

        function zoomIn() {
            scaleFactor += 0.1;
            applyTransform('left');
            applyTransform('right'); // 调用applyTransform函数对右边图片进行缩放
        }

        function zoomOut() {
            scaleFactor -= 0.1;
            applyTransform('left');
            applyTransform('right'); // 调用applyTransform函数对右边图片进行缩放
        }

        function resetZoom() {
            scaleFactor = 0.2;
            
            applyTransform('left');
            leftPreviewDiv.scrollTop = 747;
            leftPreviewDiv.scrollLeft = 1328;

            applyTransform('right');
            rightPreviewDiv.scrollTop = 747;
            rightPreviewDiv.scrollLeft = 1328; 
        }

        function applyTransform(side) {
            const image = document.querySelector(`#${side}Preview #preview-image`);
            if (image != null) {  // 如果该侧存在图片，则进行缩放操作
                image.style.transform = `scale(${scaleFactor})`;
            }
        }

        function syncScroll(side) {
            const leftScrollTop = leftPreviewDiv.scrollTop;
            const leftScrollLeft = leftPreviewDiv.scrollLeft;
            const rightPreviewDiv = document.getElementById('rightPreview');
            
            if (side === 'left') {
                rightPreviewDiv.scrollTop = leftScrollTop;
                rightPreviewDiv.scrollLeft = leftScrollLeft;
            } else {
                leftPreviewDiv.scrollTop = rightPreviewDiv.scrollTop;
                leftPreviewDiv.scrollLeft = rightPreviewDiv.scrollLeft;
            }
        }

    </script>

</body>
</html>
